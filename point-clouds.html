<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Point Clouds — Beck Andersen</title>
  <meta name="description" content="Interactive 3D point cloud viewer. Explore spatial data captured through photogrammetry and LiDAR scanning.">

  <!-- Open Graph -->
  <meta property="og:title" content="Point Clouds — Beck Andersen">
  <meta property="og:description" content="Interactive 3D point cloud viewer.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://beckandersen.com/point-clouds.html">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Point Clouds — Beck Andersen">
  <meta name="twitter:description" content="Interactive 3D point cloud viewer.">

  <link rel="canonical" href="https://beckandersen.com/point-clouds.html">

  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/pages.css">

  <!-- Three.js import map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.172.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.172.0/examples/jsm/"
    }
  }
  </script>
</head>
<body class="point-clouds-page">
  <!-- Navigation (dark variant) -->
  <nav class="site-nav site-nav--dark" role="navigation" aria-label="Main navigation">
    <a class="site-nav__name" href="index.html">beck andersen</a>
    <button class="site-nav__toggle" aria-expanded="false" aria-controls="nav-links" aria-label="Toggle navigation">
      <span class="site-nav__toggle-icon"></span>
    </button>
    <div class="site-nav__links" id="nav-links">
      <a href="index.html">work</a>
      <a href="gallery.html">gallery</a>
      <a href="point-clouds.html" class="active">point clouds</a>
      <a href="about.html">about</a>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="point-clouds-page__main">

    <!-- 3D Viewer Container -->
    <div class="point-clouds-page__viewer" id="viewer-container">

      <!-- Loading indicator -->
      <div class="point-clouds-page__loading" id="loading-indicator">
        <span id="loading-text">select a point cloud to view</span>
        <div class="loading-bar" id="loading-bar" style="display: none;">
          <div class="loading-bar__fill" id="loading-fill"></div>
        </div>
      </div>

    </div>

    <!-- Model selector (sidebar) -->
    <aside class="point-clouds-page__sidebar" id="cloud-selector">
      <h2 class="sr-only">Point Cloud Selection</h2>
      <ul class="cloud-list">
        <li>
          <button class="cloud-list__item"
                  data-ply="/point-clouds/scan-001.ply"
                  data-label="Scan 001">
            scan 001
          </button>
        </li>
        <li>
          <button class="cloud-list__item"
                  data-ply="/point-clouds/scan-002.ply"
                  data-label="Scan 002">
            scan 002
          </button>
        </li>
        <li>
          <button class="cloud-list__item"
                  data-ply="/point-clouds/scan-003.ply"
                  data-label="Scan 003">
            scan 003
          </button>
        </li>
      </ul>
    </aside>

    <!-- Controls panel -->
    <div class="point-clouds-page__controls">
      <div class="controls-panel">
        <label>
          point size
          <input type="range" id="point-size-slider"
                 min="0.001" max="0.1" step="0.001" value="0.02">
        </label>
        <label>
          color mode
          <select id="color-mode-select">
            <option value="vertex">vertex colors</option>
            <option value="height">height gradient</option>
            <option value="solid">solid white</option>
          </select>
        </label>
        <label>
          auto-rotate
          <input type="checkbox" id="auto-rotate-toggle" checked>
        </label>
      </div>
    </div>

    <!-- Point count info -->
    <div class="point-clouds-page__info" id="cloud-info"></div>

  </main>

  <!-- Navigation toggle -->
  <script>
    document.querySelector('.site-nav__toggle')?.addEventListener('click', function() {
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !expanded);
      document.getElementById('nav-links').classList.toggle('is-open');
    });
  </script>

  <!-- Point Cloud Viewer initialization -->
  <script type="module">
    import PointCloudViewer from './js/point-cloud-viewer.js';

    const container = document.getElementById('viewer-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingText = document.getElementById('loading-text');
    const loadingBar = document.getElementById('loading-bar');
    const loadingFill = document.getElementById('loading-fill');
    const cloudInfo = document.getElementById('cloud-info');

    // Initialize viewer
    const viewer = new PointCloudViewer(container);

    // Loading progress
    container.addEventListener('load-progress', (e) => {
      const { percent, loaded } = e.detail;
      if (percent >= 0) {
        loadingFill.style.width = `${percent}%`;
      } else {
        // Unknown total: show bytes loaded
        const mb = (loaded / 1024 / 1024).toFixed(1);
        loadingText.textContent = `loading... ${mb} MB`;
      }
    });

    // Cloud loaded
    container.addEventListener('cloud-loaded', (e) => {
      const { pointCount, hasColors } = e.detail;
      const formatted = pointCount.toLocaleString();
      cloudInfo.textContent = `${formatted} points`;
    });

    /**
     * Load a point cloud by URL.
     */
    async function loadCloud(url, label) {
      loadingIndicator.style.display = '';
      loadingBar.style.display = '';
      loadingFill.style.width = '0%';
      loadingText.textContent = `loading ${label}...`;
      cloudInfo.textContent = '';

      try {
        await viewer.loadPLY(url);
        loadingIndicator.style.display = 'none';
      } catch (err) {
        loadingText.textContent = 'failed to load point cloud';
        loadingBar.style.display = 'none';
        console.error(err);
      }
    }

    // Cloud selector
    document.getElementById('cloud-selector')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.cloud-list__item');
      if (!btn) return;

      // Update active state
      document.querySelectorAll('.cloud-list__item').forEach(b =>
        b.classList.remove('cloud-list__item--active'));
      btn.classList.add('cloud-list__item--active');

      loadCloud(btn.dataset.ply, btn.dataset.label);
    });

    // Point size slider
    document.getElementById('point-size-slider')?.addEventListener('input', (e) => {
      viewer.setPointSize(parseFloat(e.target.value));
    });

    // Color mode select
    document.getElementById('color-mode-select')?.addEventListener('change', (e) => {
      viewer.setColorMode(e.target.value);
    });

    // Auto-rotate toggle
    document.getElementById('auto-rotate-toggle')?.addEventListener('change', (e) => {
      viewer.setAutoRotate(e.target.checked);
    });
  </script>
</body>
</html>
